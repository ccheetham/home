#!/usr/bin/env zsh

refresh_repo() {
  local type=$1
  local url=$2
  local name=$3
  local checkout
  local update
  case $type in
    git)
      checkout='git clone'
      update='git pull'
      [[ -n $name ]] || name=$(basename $url .git)
      ;;
    hg)
      checkout='hg clone'
      update='hg pull'
      [[ -n $name ]] || name=$(basename $url)
      ;;
    *)
      echo unknown repo type \($type\) for $url >&2
      return
      ;;
  esac
  /bin/mkdir -p $ME_REPO_DIR
  if [[ -d $ME_REPO_DIR/$name ]] ; then
    echo updating repo $name \($type\)
    (cd $ME_REPO_DIR/$name && $=update)
  else
    echo checking out repo $name \($type\)
    $=checkout $url $ME_REPO_DIR/$name
  fi
}

while read line ; do
  type=$(echo $line | awk '{print $1;}')
  url=$(echo $line | awk '{print $2;}')
  target=$(echo $line | awk '{print $3;}')
  refresh_repo $type $url $target
done < $ME_CONFIG_DIR/repos
